<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TierMaker2 - Create a Tier List for Anything</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="creator-styles.css">
    <script src="github-storage.js"></script>
    <style>
        .upload-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 40px;
            color: #fff;
        }
        .upload-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 12px;
        }
        .upload-controls input[type=file] {
            color: #ccc;
        }
        .upload-controls button {
            background: #38bdf8;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: #022;
            font-weight: 600;
        }
        .upload-controls button.ghost {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            color: #ccc;
        }
        .upload-status {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 10px;
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
            gap: 12px;
        }
        .gallery-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }
        .gallery-item img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
        }
        .gallery-item button {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #ccc;
            margin-top: 6px;
            cursor: pointer;
        }
        
        /* Template like button styles */
        .template-item {
            position: relative;
        }
        
        .template-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .template-item:hover .template-actions {
            opacity: 1;
        }
        
        .like-btn {
            background: rgba(0,0,0,0.7);
            border: none;
            border-radius: 4px;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }
        
        .like-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .like-btn.liked {
            background: #ff4757;
            color: white;
        }
        
        .like-btn.liked:hover {
            background: #ff3838;
        }
        
        .category-section {
            margin-bottom: 40px;
        }
        
        .category-section.hidden {
            display: none;
        }
        
        /* Consistent template title sizing */
        .template-title {
            color: #ffffff;
            font-size: 14px !important;
            font-weight: 500;
            text-align: center;
            margin-top: 10px;
            line-height: 1.3;
            min-height: 36px; /* Ensure consistent height */
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
    </style>
</head>
<body>
    <nav class="main-navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="#" class="logo">TierMaker2</a>
            </div>
            <div class="nav-center">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search for a template...">
                    <button class="search-btn">üîç</button>
                </div>
            </div>
            <div class="nav-right">
                <a href="create-template.html" class="nav-link" id="highlighted">Create a Template</a>
                <a href="manage-templates.html" class="nav-link">My Templates</a>
                <button id="github-login-btn" class="login-btn" style="display: block;">Login</button>
                <div id="user-info" class="user-info" style="display: none;">
                    <span id="username"></span>
                    <button id="github-logout-btn" class="logout-btn">Logout</button>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <header class="main-header">
            <h1>Tiermaker but Better</h1>
        </header>

        <main class="main-content">
            <section class="featured-section">
                <h3 class="featured-title">üî¥ Most Voted</h3>
                <div class="template-list">
                    <button class="nav-arrow nav-arrow-left" disabled>‚Äπ</button>
                    <div class="template-grid-container">
                        <div class="template-grid">
                            
                        </div>
                    </div>
                    <button class="nav-arrow nav-arrow-right">‚Ä∫</button>
                </div>
            </section>

            <!-- Category Sections -->
            <section class="category-section" id="gaming-section">
                <div class="section-header">
                    <h3 class="featured-title">üéÆ Gaming Templates</h3>
                </div>
                <div class="template-list" id="gaming-templates-list">
                    <button class="nav-arrow nav-arrow-left" id="gaming-left" disabled>‚Äπ</button>
                    <div class="template-grid-container">
                        <div class="template-grid" id="gaming-template-grid">
                            <div class="loading-message">Loading gaming templates...</div>
                        </div>
                    </div>
                    <button class="nav-arrow nav-arrow-right" id="gaming-right">‚Ä∫</button>
                </div>
            </section>

            <section class="category-section" id="ocs-section">
                <div class="section-header">
                    <h3 class="featured-title">üåü OCs Templates</h3>
                </div>
                <div class="template-list" id="ocs-templates-list">
                    <button class="nav-arrow nav-arrow-left" id="ocs-left" disabled>‚Äπ</button>
                    <div class="template-grid-container">
                        <div class="template-grid" id="ocs-template-grid">
                            <div class="loading-message">Loading OCs templates...</div>
                        </div>
                    </div>
                    <button class="nav-arrow nav-arrow-right" id="ocs-right">‚Ä∫</button>
                </div>
            </section>

            <section class="category-section" id="movies-section">
                <div class="section-header">
                    <h3 class="featured-title">üé¨ Movies & TV Templates</h3>
                </div>
                <div class="template-list" id="movies-templates-list">
                    <button class="nav-arrow nav-arrow-left" id="movies-left" disabled>‚Äπ</button>
                    <div class="template-grid-container">
                        <div class="template-grid" id="movies-template-grid">
                            <div class="loading-message">Loading movies & TV templates...</div>
                        </div>
                    </div>
                    <button class="nav-arrow nav-arrow-right" id="movies-right">‚Ä∫</button>
                </div>
            </section>

            <section class="category-section" id="music-section">
                <div class="section-header">
                    <h3 class="featured-title">üéµ Music Templates</h3>
                </div>
                <div class="template-list" id="music-templates-list">
                    <button class="nav-arrow nav-arrow-left" id="music-left" disabled>‚Äπ</button>
                    <div class="template-grid-container">
                        <div class="template-grid" id="music-template-grid">
                            <div class="loading-message">Loading music templates...</div>
                        </div>
                    </div>
                    <button class="nav-arrow nav-arrow-right" id="music-right">‚Ä∫</button>
                </div>
            </section>

            <section class="category-section" id="food-section">
                <div class="section-header">
                    <h3 class="featured-title">üçï Food & Drinks Templates</h3>
                </div>
                <div class="template-list" id="food-templates-list">
                    <button class="nav-arrow nav-arrow-left" id="food-left" disabled>‚Äπ</button>
                    <div class="template-grid-container">
                        <div class="template-grid" id="food-template-grid">
                            <div class="loading-message">Loading food & drinks templates...</div>
                        </div>
                    </div>
                    <button class="nav-arrow nav-arrow-right" id="food-right">‚Ä∫</button>
                </div>
            </section>

            <section class="recent-templates-section">
                <div class="section-header">
                    <h3 class="featured-title">üïí Recent Templates</h3>
                </div>
                <div class="template-list" id="recent-templates-list">
                    <button class="nav-arrow nav-arrow-left" id="recent-left" disabled>‚Äπ</button>
                    <div class="template-grid-container">
                        <div class="template-grid" id="recent-template-grid">
                            <div class="loading-message">Loading recent templates...</div>
                        </div>
                    </div>
                    <button class="nav-arrow nav-arrow-right" id="recent-right">‚Ä∫</button>
                </div>
            </section>

            
        </main>

        <footer class="main-footer">
            <p>¬© 2025 tiermaker.com</p>
        </footer>
    </div>
    
    <script>
        let recentTemplates = [];
        let currentRecentPage = 0;
        const itemsPerPage = 6;
        
        // Category templates storage
        let categoryTemplates = {
            gaming: [],
            OCs: [],
            movies: [],
            music: [],
            food: []
        };
        let currentCategoryPages = {
            gaming: 0,
            OCs: 0,
            movies: 0,
            music: 0,
            food: 0
        };
        
        // User likes storage
        let userLikes = [];
        
        // Check localStorage availability
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.error('localStorage is not available:', e);
                return false;
            }
        }
        
        // Initialize user likes
        try {
            if (isLocalStorageAvailable()) {
                const storedLikes = localStorage.getItem('template_likes');
                if (storedLikes) {
                    const parsedLikes = JSON.parse(storedLikes);
                    // Ensure it's an array
                    userLikes = Array.isArray(parsedLikes) ? parsedLikes : [];
                } else {
                    userLikes = [];
                }
                console.log('Loaded user likes from localStorage:', userLikes);
            } else {
                console.warn('localStorage not available, likes will not persist');
                userLikes = [];
            }
        } catch (error) {
            console.error('Error loading user likes from localStorage:', error);
            userLikes = [];
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize GitHub storage
            await githubStorage.initAuth();
            updateNavAuthUI();
            
            // Load user likes if authenticated
            if (githubStorage.authenticated) {
                await loadUserLikes();
            }
            
            // Load recent templates
            await loadRecentTemplates();
            
            // Load most voted templates
            await loadMostVotedTemplates();
            
            // Load category templates
            await loadCategoryTemplates();
            
            // Set up original template navigation (after most voted is loaded)
            setupOriginalNavigation();
            
            // Set up recent template navigation
            setupRecentNavigation();
            
            // Set up category navigation
            setupCategoryNavigation();
            
            // Set up auth buttons
            setupNavAuthButtons();
            
            // Set up search functionality
            setupSearchFunctionality();
            
            // Rebuild global search collection after all data is loaded
            setTimeout(() => {
                buildGlobalTemplateCollection();
            }, 1000);
        });

        async function loadUserLikes() {
            try {
                userLikes = await githubStorage.getUserLikes();
            } catch (error) {
                console.error('Error loading user likes:', error);
                userLikes = [];
            }
        }

        async function loadMostVotedTemplates() {
            try {
                // Get all public templates
                const allTemplates = await githubStorage.getPublicTemplates();
                
                // Load likes for all templates
                await loadLikesForTemplates(allTemplates);
                
                // Sort by likes (descending) and take top templates
                const mostVoted = allTemplates
                    .filter(t => t.likes > 0) // Only show templates with likes
                    .sort((a, b) => (b.likes || 0) - (a.likes || 0))
                    .slice(0, 12); // Show top 12 most liked
                
                console.log('Most voted templates:', mostVoted.map(t => ({ name: t.name, likes: t.likes })));
                
                // Replace static templates with dynamic most voted
                displayMostVotedTemplates(mostVoted);
                
            } catch (error) {
                console.error('Error loading most voted templates:', error);
                // Keep static templates as fallback
            }
        }

        function displayMostVotedTemplates(templates) {
            const grid = document.querySelector('.featured-section .template-grid');
            
            if (templates.length === 0) {
                // Keep existing static templates if no voted templates
                return;
            }
            
            // Clear existing static templates
            grid.innerHTML = '';
            
            templates.forEach((template, index) => {
                const templateItem = createTemplateElement(template, 'most-voted');
                templateItem.classList.add('static-template'); // For consistent styling
                
                // Hide templates beyond first page (6 items)
                if (index >= 6) {
                    templateItem.classList.add('hidden');
                }
                
                grid.appendChild(templateItem);
            });
            
            // Update navigation for most voted section
            updateMostVotedNavigation(templates.length);
        }

        function updateMostVotedNavigation(totalTemplates) {
            const leftArrow = document.querySelector('.featured-section .nav-arrow-left');
            const rightArrow = document.querySelector('.featured-section .nav-arrow-right');
            const totalPages = Math.ceil(totalTemplates / itemsPerPage);
            
            if (leftArrow && rightArrow) {
                // Reset to page 0
                leftArrow.disabled = true;
                rightArrow.disabled = totalPages <= 1;
            }
        }

        async function loadCategoryTemplates() {
            try {
                const allTemplates = await githubStorage.getPublicTemplates();
                console.log('All templates loaded:', allTemplates.length);
                console.log('Templates with categories:', allTemplates.filter(t => t.category).map(t => ({ name: t.name, category: t.category })));
                console.log('All template categories found:', [...new Set(allTemplates.map(t => t.category).filter(Boolean))]);
                
                // Categorize templates
                categoryTemplates = {
                    gaming: allTemplates.filter(t => t.category === 'gaming'),
                    OCs: allTemplates.filter(t => t.category === 'OCs'),
                    movies: allTemplates.filter(t => t.category === 'movies'),
                    music: allTemplates.filter(t => t.category === 'music'),
                    food: allTemplates.filter(t => t.category === 'food')
                };
                
                console.log('Category breakdown:');
                Object.keys(categoryTemplates).forEach(category => {
                    console.log(`${category}: ${categoryTemplates[category].length} templates`);
                    if (categoryTemplates[category].length > 0) {
                        console.log(`  - ${category} templates:`, categoryTemplates[category].map(t => t.name));
                    }
                });
                
                // Load likes for all category templates
                for (const category of Object.keys(categoryTemplates)) {
                    await loadLikesForTemplates(categoryTemplates[category]);
                    // Sort each category by creation date
                    categoryTemplates[category].sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                }
                
                // Display each category
                console.log('Displaying categories...');
                displayCategoryTemplates('gaming');
                displayCategoryTemplates('OCs');
                displayCategoryTemplates('movies');
                displayCategoryTemplates('music');
                displayCategoryTemplates('food');
                
            } catch (error) {
                console.error('Error loading category templates:', error);
                // Show error in all category grids
                const categoryIds = ['gaming', 'ocs', 'movies', 'music', 'food'];
                categoryIds.forEach(categoryId => {
                    const grid = document.getElementById(`${categoryId}-template-grid`);
                    if (grid) {
                        grid.innerHTML = '<div class="loading-message">Failed to load templates.</div>';
                    }
                });
            }
        }

        function displayCategoryTemplates(category) {
            const templates = categoryTemplates[category];
            
            // Map category names to their actual HTML IDs
            const categoryIdMap = {
                'gaming': 'gaming',
                'OCs': 'ocs',
                'movies': 'movies', 
                'music': 'music',
                'food': 'food'
            };
            
            const categoryId = categoryIdMap[category];
            if (!categoryId) {
                console.error(`Unknown category: ${category}`);
                return;
            }
            
            const grid = document.getElementById(`${categoryId}-template-grid`);
            const section = document.getElementById(`${categoryId}-section`);
            
            if (!grid || !section) {
                console.error(`Missing DOM elements for category ${category}:`, {
                    grid: !!grid,
                    section: !!section,
                    expectedGridId: `${categoryId}-template-grid`,
                    expectedSectionId: `${categoryId}-section`
                });
                return;
            }
            
            console.log(`Displaying ${category} templates:`, templates.length);
            
            if (templates.length === 0) {
                grid.innerHTML = '<div class="loading-message">No templates in this category yet.</div>';
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            grid.innerHTML = '';
            
            const currentPage = currentCategoryPages[category];
            templates.forEach((template, index) => {
                const templateItem = createTemplateElement(template, category);
                if (Math.floor(index / itemsPerPage) !== currentPage) {
                    templateItem.classList.add('hidden');
                }
                grid.appendChild(templateItem);
            });
            
            updateCategoryNavigation(category);
        }

        function createTemplateElement(template, section = 'recent') {
            const templateItem = document.createElement('div');
            templateItem.className = 'template-item';
            
            const thumbnailImage = template.thumbnail 
                ? template.thumbnail 
                : (template.images && template.images.length > 0 
                    ? template.images[0].src 
                    : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" fill="%23666"><rect width="120" height="120"/><text x="60" y="60" text-anchor="middle" dy=".3em" fill="white">No Image</text></svg>');
            
            const creatorInfo = template.creator ? 
                `<div class="template-creator">by @${template.creator.username}</div>` : 
                '<div class="template-creator">Anonymous</div>';
            
            // Get the current user likes from localStorage to ensure it's up to date
            let currentUserLikes = [];
            try {
                if (isLocalStorageAvailable()) {
                    const storedLikes = localStorage.getItem('template_likes');
                    if (storedLikes) {
                        const parsedLikes = JSON.parse(storedLikes);
                        // Ensure it's an array
                        currentUserLikes = Array.isArray(parsedLikes) ? parsedLikes : [];
                    }
                }
            } catch (error) {
                console.error('Error loading user likes in createTemplateElement:', error);
                // Fallback to global userLikes if it exists and is an array
                currentUserLikes = (window.userLikes && Array.isArray(window.userLikes)) ? window.userLikes : [];
            }
            
            const isLiked = currentUserLikes.includes(template.id);
            const likesCount = template.likes || 0;
            
            templateItem.innerHTML = `
                <div class="template-image">
                    <img src="${thumbnailImage}" alt="${template.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"120\\" height=\\"120\\" fill=\\"%23666\\"><rect width=\\"120\\" height=\\"120\\"/><text x=\\"60\\" y=\\"60\\" text-anchor=\\"middle\\" dy=\\".3em\\" fill=\\"white\\">No Image</text></svg>'">
                    <div class="template-actions">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${template.id}', this, '${section}')">
                            ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span class="like-count">${likesCount}</span>
                        </button>
                    </div>
                </div>
                <div class="template-info">
                    <div class="template-title">${template.name}</div>
                    ${creatorInfo}
                </div>
            `;
            
            templateItem.addEventListener('click', (e) => {
                // Don't navigate if clicking the like button
                if (e.target.closest('.like-btn')) return;
                window.location.href = `create-template.html?template=${template.id}&public=true`;
            });
            
            return templateItem;
        }

        async function toggleLike(templateId, buttonElement, section) {
            try {
                console.log('Toggling like for template:', templateId, 'in section:', section);
                
                // Check if localStorage is available
                if (!isLocalStorageAvailable()) {
                    throw new Error('Local storage is not available. Likes cannot be saved.');
                }
                
                // Use localStorage for likes since GitHub Pages can't write to GitHub API
                let userLikes = [];
                let templateLikes = {};
                
                try {
                    const storedUserLikes = localStorage.getItem('template_likes');
                    if (storedUserLikes) {
                        const parsedUserLikes = JSON.parse(storedUserLikes);
                        userLikes = Array.isArray(parsedUserLikes) ? parsedUserLikes : [];
                    }
                } catch (parseError) {
                    console.error('Error parsing user likes:', parseError);
                    userLikes = [];
                }
                
                try {
                    const storedTemplateLikes = localStorage.getItem('template_like_counts');
                    if (storedTemplateLikes) {
                        const parsedTemplateLikes = JSON.parse(storedTemplateLikes);
                        templateLikes = (typeof parsedTemplateLikes === 'object' && parsedTemplateLikes !== null) ? parsedTemplateLikes : {};
                    }
                } catch (parseError) {
                    console.error('Error parsing template likes:', parseError);
                    templateLikes = {};
                }
                
                console.log('Current user likes:', userLikes);
                console.log('Current template likes:', templateLikes);
                
                const isCurrentlyLiked = userLikes.includes(templateId);
                console.log('Is currently liked:', isCurrentlyLiked);
                
                if (isCurrentlyLiked) {
                    // Unlike
                    userLikes = userLikes.filter(id => id !== templateId);
                    templateLikes[templateId] = Math.max(0, (templateLikes[templateId] || 0) - 1);
                    buttonElement.classList.remove('liked');
                    buttonElement.innerHTML = `ü§ç <span class="like-count">${templateLikes[templateId] || 0}</span>`;
                    console.log('Unliked template. New like count:', templateLikes[templateId]);
                } else {
                    // Like
                    userLikes.push(templateId);
                    templateLikes[templateId] = (templateLikes[templateId] || 0) + 1;
                    buttonElement.classList.add('liked');
                    buttonElement.innerHTML = `‚ù§Ô∏è <span class="like-count">${templateLikes[templateId]}</span>`;
                    console.log('Liked template. New like count:', templateLikes[templateId]);
                }
                
                // Save to localStorage
                try {
                    localStorage.setItem('template_likes', JSON.stringify(userLikes));
                    localStorage.setItem('template_like_counts', JSON.stringify(templateLikes));
                    console.log('Successfully saved to localStorage');
                } catch (storageError) {
                    console.error('Error saving to localStorage:', storageError);
                    throw new Error('Failed to save like data to local storage: ' + storageError.message);
                }
                
                // Update the global userLikes array
                window.userLikes = userLikes;
                
                // Update the template object in the appropriate array
                try {
                    if (section === 'recent') {
                        const template = recentTemplates.find(t => t.id === templateId);
                        if (template) {
                            template.likes = templateLikes[templateId] || 0;
                            console.log('Updated recent template likes:', template.likes);
                        }
                    } else {
                        const template = categoryTemplates[section]?.find(t => t.id === templateId);
                        if (template) {
                            template.likes = templateLikes[templateId] || 0;
                            console.log('Updated category template likes:', template.likes);
                        }
                    }
                } catch (updateError) {
                    console.error('Error updating template object:', updateError);
                    // Don't throw here as the like was already saved successfully
                }
                
                console.log('Like toggle completed successfully');
                
            } catch (error) {
                console.error('Error toggling like:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    templateId,
                    section
                });
                
                // Revert button state on error
                try {
                    const currentLikesStr = localStorage.getItem('template_like_counts');
                    let currentLikes = {};
                    if (currentLikesStr) {
                        const parsed = JSON.parse(currentLikesStr);
                        currentLikes = (typeof parsed === 'object' && parsed !== null) ? parsed : {};
                    }
                    
                    const currentUserLikesStr = localStorage.getItem('template_likes');
                    let currentUserLikes = [];
                    if (currentUserLikesStr) {
                        const parsed = JSON.parse(currentUserLikesStr);
                        currentUserLikes = Array.isArray(parsed) ? parsed : [];
                    }
                    
                    const isLiked = currentUserLikes.includes(templateId);
                    const likeCount = currentLikes[templateId] || 0;
                    
                    if (isLiked) {
                        buttonElement.classList.add('liked');
                        buttonElement.innerHTML = `‚ù§Ô∏è <span class="like-count">${likeCount}</span>`;
                    } else {
                        buttonElement.classList.remove('liked');
                        buttonElement.innerHTML = `ü§ç <span class="like-count">${likeCount}</span>`;
                    }
                } catch (revertError) {
                    console.error('Error reverting button state:', revertError);
                }
                
                // Show a more specific error message
                let errorMessage = 'Failed to update like. ';
                if (error.message.includes('localStorage') || error.message.includes('storage')) {
                    errorMessage += 'Local storage might be full or disabled. Please check your browser settings.';
                } else if (error.message.includes('available')) {
                    errorMessage += 'Browser storage is not available.';
                } else {
                    errorMessage += 'Please try again.';
                }
                alert(errorMessage);
            }
        }

        async function loadRecentTemplates() {
            const grid = document.getElementById('recent-template-grid');
            grid.innerHTML = '<div class="loading-message">Loading recent templates...</div>';
            
            try {
                recentTemplates = await githubStorage.getPublicTemplates();
                // Sort by creation date (most recent first)
                recentTemplates.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                
                // Load likes for each template
                await loadLikesForTemplates(recentTemplates);
                
                // Store original templates for search functionality
                originalRecentTemplates = [...recentTemplates];
                
                displayRecentTemplates();
            } catch (error) {
                console.error('Error loading recent templates:', error);
                grid.innerHTML = '<div class="loading-message">Failed to load recent templates. Check console for details.</div>';
            }
        }

        async function loadLikesForTemplates(templates) {
            // Load likes from localStorage instead of GitHub API
            let templateLikes = {};
            
            try {
                const storedTemplateLikes = localStorage.getItem('template_like_counts');
                if (storedTemplateLikes) {
                    const parsed = JSON.parse(storedTemplateLikes);
                    templateLikes = (typeof parsed === 'object' && parsed !== null) ? parsed : {};
                }
            } catch (error) {
                console.error('Error loading template likes in loadLikesForTemplates:', error);
                templateLikes = {};
            }
            
            if (Array.isArray(templates)) {
                templates.forEach(template => {
                    template.likes = templateLikes[template.id] || 0;
                });
            }
        }

        function displayRecentTemplates() {
            const grid = document.getElementById('recent-template-grid');
            
            if (recentTemplates.length === 0) {
                grid.innerHTML = '<div class="loading-message">No recent templates available yet. Create and share the first one!</div>';
                return;
            }

            grid.innerHTML = '';
            recentTemplates.forEach((template, index) => {
                const templateItem = createTemplateElement(template, 'recent');
                templateItem.classList.add('recent');
                if (Math.floor(index / itemsPerPage) !== currentRecentPage) {
                    templateItem.classList.add('hidden');
                }
                grid.appendChild(templateItem);
            });

            updateRecentNavigation();
        }

        function setupCategoryNavigation() {
            Object.keys(categoryTemplates).forEach(category => {
                setupCategoryNavigationForCategory(category);
            });
        }

        function setupCategoryNavigationForCategory(category) {
            // Map category names to their actual HTML IDs
            const categoryIdMap = {
                'gaming': 'gaming',
                'OCs': 'ocs',
                'movies': 'movies', 
                'music': 'music',
                'food': 'food'
            };
            
            const categoryId = categoryIdMap[category];
            if (!categoryId) {
                console.error(`Unknown category for navigation: ${category}`);
                return;
            }
            
            const leftArrow = document.getElementById(`${categoryId}-left`);
            const rightArrow = document.getElementById(`${categoryId}-right`);
            
            if (!leftArrow || !rightArrow) {
                console.error(`Missing navigation elements for category ${category}:`, {
                    leftArrow: !!leftArrow,
                    rightArrow: !!rightArrow,
                    expectedLeftId: `${categoryId}-left`,
                    expectedRightId: `${categoryId}-right`
                });
                return;
            }
            
            leftArrow.addEventListener('click', () => {
                if (currentCategoryPages[category] > 0) {
                    currentCategoryPages[category]--;
                    displayCategoryTemplates(category);
                }
            });
            
            rightArrow.addEventListener('click', () => {
                const totalPages = Math.ceil(categoryTemplates[category].length / itemsPerPage);
                if (currentCategoryPages[category] < totalPages - 1) {
                    currentCategoryPages[category]++;
                    displayCategoryTemplates(category);
                }
            });
        }

        function updateCategoryNavigation(category) {
            // Map category names to their actual HTML IDs
            const categoryIdMap = {
                'gaming': 'gaming',
                'OCs': 'ocs',
                'movies': 'movies', 
                'music': 'music',
                'food': 'food'
            };
            
            const categoryId = categoryIdMap[category];
            if (!categoryId) return;
            
            const leftArrow = document.getElementById(`${categoryId}-left`);
            const rightArrow = document.getElementById(`${categoryId}-right`);
            const totalPages = Math.ceil(categoryTemplates[category].length / itemsPerPage);
            
            if (leftArrow && rightArrow) {
                leftArrow.disabled = currentCategoryPages[category] === 0;
                rightArrow.disabled = currentCategoryPages[category] >= totalPages - 1 || totalPages <= 1;
            }
        }

        function setupOriginalNavigation() {
            const leftArrow = document.querySelector('.featured-section .nav-arrow-left');
            const rightArrow = document.querySelector('.featured-section .nav-arrow-right');
            
            // Get all template items in the featured section (both static and dynamic)
            const templateItems = document.querySelectorAll('.featured-section .template-item');
            let currentPage = 0;
            const totalPages = Math.ceil(templateItems.length / itemsPerPage);
            
            // Remove existing event listeners by cloning elements
            if (leftArrow && rightArrow) {
                const newLeftArrow = leftArrow.cloneNode(true);
                const newRightArrow = rightArrow.cloneNode(true);
                leftArrow.parentNode.replaceChild(newLeftArrow, leftArrow);
                rightArrow.parentNode.replaceChild(newRightArrow, rightArrow);
                
                function showPage(page) {
                    templateItems.forEach((item, index) => {
                        const pageIndex = Math.floor(index / itemsPerPage);
                        if (pageIndex === page) item.classList.remove('hidden');
                        else item.classList.add('hidden');
                    });
                    newLeftArrow.disabled = page === 0;
                    newRightArrow.disabled = page === totalPages - 1 || totalPages <= 1;
                }
                
                newLeftArrow.addEventListener('click', () => {
                    if (currentPage > 0) { currentPage--; showPage(currentPage); }
                });
                
                newRightArrow.addEventListener('click', () => {
                    if (currentPage < totalPages - 1) { currentPage++; showPage(currentPage); }
                });
                
                // Always start from page 0 when setting up navigation
                currentPage = 0;
                showPage(currentPage);
            }
        }

        function setupRecentNavigation() {
            const leftArrow = document.getElementById('recent-left');
            const rightArrow = document.getElementById('recent-right');
            
            leftArrow.addEventListener('click', () => {
                if (currentRecentPage > 0) {
                    currentRecentPage--;
                    displayRecentTemplates();
                }
            });
            
            rightArrow.addEventListener('click', () => {
                const totalPages = Math.ceil(recentTemplates.length / itemsPerPage);
                if (currentRecentPage < totalPages - 1) {
                    currentRecentPage++;
                    displayRecentTemplates();
                }
            });
        }

        function updateRecentNavigation() {
            const leftArrow = document.getElementById('recent-left');
            const rightArrow = document.getElementById('recent-right');
            const totalPages = Math.ceil(recentTemplates.length / itemsPerPage);
            
            leftArrow.disabled = currentRecentPage === 0;
            rightArrow.disabled = currentRecentPage >= totalPages - 1 || totalPages <= 1;
        }

        function setupNavAuthButtons() {
            const loginBtn = document.getElementById('github-login-btn');
            const logoutBtn = document.getElementById('github-logout-btn');
            
            loginBtn.addEventListener('click', async () => {
                const success = await githubStorage.login();
                if (success) {
                    updateNavAuthUI();
                    await loadRecentTemplates();
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                githubStorage.logout();
                updateNavAuthUI();
            });
        }

        async function updateNavAuthUI() {
            const loginBtn = document.getElementById('github-login-btn');
            const userInfo = document.getElementById('user-info');
            const username = document.getElementById('username');
            
            if (githubStorage.authenticated) {
                const user = await githubStorage.getCurrentUser();
                if (user) {
                    username.textContent = `@${user.login}`;
                    loginBtn.style.display = 'none';
                    userInfo.style.display = 'flex';
                } else {
                    // Token might be invalid
                    githubStorage.logout();
                    loginBtn.style.display = 'block';
                    userInfo.style.display = 'none';
                }
            } else {
                loginBtn.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }

        // Search functionality
        let allGlobalTemplates = []; // Will store ALL template data for searching
        let isSearchActive = false;
        let searchResults = [];

        function setupSearchFunctionality() {
            const searchInput = document.querySelector('.search-input');
            const searchBtn = document.querySelector('.search-btn');
            
            // Build global template collection
            buildGlobalTemplateCollection();
            
            // Set up search event listeners
            searchInput.addEventListener('input', handleGlobalSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleGlobalSearch();
                }
            });
            
            searchBtn.addEventListener('click', handleGlobalSearch);
            
            // Clear search when input is empty
            searchInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    clearGlobalSearch();
                }
            });
        }

        function buildGlobalTemplateCollection() {
            // Collect all templates from different sources
            allGlobalTemplates = [];
            
            // Add recent templates
            recentTemplates.forEach(template => {
                allGlobalTemplates.push({
                    ...template,
                    source: 'recent'
                });
            });
            
            // Add category templates
            Object.keys(categoryTemplates).forEach(category => {
                categoryTemplates[category].forEach(template => {
                    // Avoid duplicates (template might be in both recent and category)
                    if (!allGlobalTemplates.find(t => t.id === template.id)) {
                        allGlobalTemplates.push({
                            ...template,
                            source: category
                        });
                    }
                });
            });
            
            console.log('Global template collection built:', allGlobalTemplates.length);
        }

        function handleGlobalSearch() {
            const searchInput = document.querySelector('.search-input');
            const query = searchInput.value.trim().toLowerCase();
            
            if (query === '') {
                clearGlobalSearch();
                return;
            }
            
            isSearchActive = true;
            
            // Search across all templates
            searchResults = allGlobalTemplates.filter(template => {
                return template.name.toLowerCase().includes(query) ||
                       (template.description && template.description.toLowerCase().includes(query)) ||
                       (template.creator && template.creator.username.toLowerCase().includes(query)) ||
                       (template.category && template.category.toLowerCase().includes(query));
            });
            
            console.log(`Search for "${query}" found ${searchResults.length} templates`);
            
            // Hide all sections
            hideAllSections();
            
            // Show search results
            displayGlobalSearchResults(query);
        }

        function hideAllSections() {
            const sections = [
                '.featured-section',
                '.recent-templates-section',
                '.category-section'
            ];
            
            sections.forEach(selector => {
                const section = document.querySelector(selector) || document.querySelectorAll(selector);
                if (section.length) {
                    section.forEach(s => s.style.display = 'none');
                } else if (section.style) {
                    section.style.display = 'none';
                }
            });
            
            // Hide all category sections
            document.querySelectorAll('.category-section').forEach(section => {
                section.style.display = 'none';
            });
        }

        function displayGlobalSearchResults(query) {
            // Create or get search results section
            let searchSection = document.getElementById('global-search-results');
            if (!searchSection) {
                searchSection = document.createElement('section');
                searchSection.id = 'global-search-results';
                searchSection.className = 'search-results-section';
                searchSection.innerHTML = `
                    <div class="section-header">
                        <h3 class="featured-title" id="search-results-title">üîç Search Results</h3>
                    </div>
                    <div class="template-list">
                        <div class="template-grid-container">
                            <div class="template-grid" id="search-results-grid">
                            </div>
                        </div>
                    </div>
                `;
                
                // Insert after recent templates section
                const recentSection = document.querySelector('.recent-templates-section');
                recentSection.parentNode.insertBefore(searchSection, recentSection.nextSibling);
            }
            
            const grid = document.getElementById('search-results-grid');
            const title = document.getElementById('search-results-title');
            
            title.textContent = `üîç Search Results for "${query}" (${searchResults.length} found)`;
            searchSection.style.display = 'block';
            
            if (searchResults.length === 0) {
                grid.innerHTML = '<div class="loading-message">No templates found matching your search.</div>';
                return;
            }
            
            // Display search results
            grid.innerHTML = '';
            searchResults.forEach((template, index) => {
                const templateItem = createTemplateElement(template, 'search');
                grid.appendChild(templateItem);
            });
        }

        function clearGlobalSearch() {
            if (!isSearchActive) return;
            
            isSearchActive = false;
            searchResults = [];
            
            // Hide search results section
            const searchSection = document.getElementById('global-search-results');
            if (searchSection) {
                searchSection.style.display = 'none';
            }
            
            // Show all sections again
            document.querySelector('.featured-section').style.display = 'block';
            document.querySelector('.recent-templates-section').style.display = 'block';
            
            // Show category sections that have templates
            Object.keys(categoryTemplates).forEach(category => {
                if (categoryTemplates[category].length > 0) {
                    const categoryIdMap = {
                        'gaming': 'gaming',
                        'OCs': 'ocs',
                        'movies': 'movies',
                        'music': 'music',
                        'food': 'food'
                    };
                    const categoryId = categoryIdMap[category];
                    if (categoryId) {
                        const section = document.getElementById(`${categoryId}-section`);
                        if (section) {
                            section.style.display = 'block';
                        }
                    }
                }
            });
            
            // Clear search input
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.value = '';
            }
        }

    </script>

</body>
</html>
